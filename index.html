<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø£Ø¯Ø§Ø© Ø³Ù„Ø© â€” Ø±Ø¨Ø· ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±</title>
<link href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
:root{--bg:#07060d;--surface:#100f17;--surface2:#1a1826;--surface3:#242232;--border:#2a2740;--border2:#3a3655;--text:#ece8f4;--text2:#8b85a0;--text3:#5e5872;--accent:#a78bfa;--accent-dim:rgba(167,139,250,0.1);--green:#34d399;--green-dim:rgba(52,211,153,0.1);--red:#f87171;--red-dim:rgba(248,113,113,0.1);--amber:#fbbf24;--amber-dim:rgba(251,191,36,0.1);--blue:#60a5fa;--blue-dim:rgba(96,165,250,0.1);--radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Readex Pro',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6}
.grain{position:fixed;inset:0;pointer-events:none;opacity:0.02;z-index:9999;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}
.glow{position:fixed;top:-180px;left:50%;transform:translateX(-50%);width:700px;height:450px;background:radial-gradient(ellipse,rgba(167,139,250,0.07),transparent 70%);pointer-events:none;z-index:0}
.app{max-width:900px;margin:0 auto;padding:40px 20px 80px;position:relative;z-index:1}
.hdr{text-align:center;margin-bottom:40px}
.hdr .badge{display:inline-block;padding:4px 14px;border-radius:20px;font-size:0.7rem;font-weight:500;background:var(--accent-dim);color:var(--accent);margin-bottom:14px}
.hdr h1{font-size:1.6rem;font-weight:700;margin-bottom:6px}
.hdr p{color:var(--text2);font-size:0.84rem;font-weight:300}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:20px}
.card h2{font-size:1rem;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.card h2 .num{width:28px;height:28px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700}
.ff{margin-bottom:14px}
.ff label{display:block;font-size:0.75rem;color:var(--text2);margin-bottom:4px}
.ff input{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:0.82rem;outline:none;direction:ltr;text-align:left}
.ff input:focus{border-color:var(--accent)}
.ff .hint{font-size:0.68rem;color:var(--text3);margin-top:3px}
.btn{padding:12px 24px;border:none;border-radius:10px;font-family:inherit;font-size:0.88rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{transform:translateY(-1px);opacity:0.9}
.btn-accent{background:var(--accent);color:#fff}
.btn-green{background:var(--green);color:#111}
.btn-red{background:var(--red);color:#fff}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--accent)}
.btn:disabled{opacity:0.3;cursor:not-allowed;transform:none}
.status{padding:12px 16px;border-radius:10px;font-size:0.78rem;margin-top:12px;display:none;direction:ltr;text-align:left}
.status.ok{display:block;background:var(--green-dim);color:var(--green);border:1px solid rgba(52,211,153,0.2)}
.status.err{display:block;background:var(--red-dim);color:var(--red);border:1px solid rgba(248,113,113,0.2)}
.status.info{display:block;background:var(--blue-dim);color:var(--blue);border:1px solid rgba(96,165,250,0.2)}
.status.warn{display:block;background:var(--amber-dim);color:var(--amber);border:1px solid rgba(251,191,36,0.2)}
.token-box{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-family:monospace;font-size:0.72rem;color:var(--accent);word-break:break-all;margin-top:10px;direction:ltr;text-align:left}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.hidden{display:none!important}
.log{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;font-size:0.72rem;color:var(--text2);max-height:200px;overflow-y:auto;font-family:monospace;line-height:1.8;direction:ltr;text-align:left;margin-top:12px;white-space:pre-wrap;word-break:break-all}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin:16px 0}
.st{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
.st .n{font-size:1.3rem;font-weight:700;margin-bottom:2px}
.st .l{font-size:0.66rem;color:var(--text2)}
.prog{height:4px;background:var(--surface2);border-radius:4px;margin:12px 0;overflow:hidden}
.prog .bar{height:100%;background:var(--accent);transition:width 0.3s;width:0;border-radius:4px}
.sup-upload{background:var(--surface2);border:1.5px dashed var(--border);border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s}
.sup-upload:hover{border-color:var(--accent);background:var(--surface3)}
.sup-upload input{display:none}
.sup-upload.ok{border-color:var(--green);border-style:solid}
</style>
</head>
<body>
<div class="grain"></div>
<div class="glow"></div>
<div class="app">
  <div class="hdr">
    <div class="badge">SALLA CONNECTOR v1</div>
    <h1>Ø±Ø¨Ø· ÙˆØªØ­Ø¯ÙŠØ« Ù…Ø®Ø²ÙˆÙ† Ø³Ù„Ø©</h1>
    <p>Ø±Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ API Ø³Ù„Ø© â€” Ø³Ø­Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª</p>
  </div>

  <!-- STEP 1: Auth -->
  <div class="card" id="step1">
    <h2><span class="num">1</span> Ø±Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø±</h2>
    <div id="authForm">
      <div class="hint" style="margin-bottom:12px">
        ğŸ” Ø§Ù„Ø±Ø¨Ø· ÙŠØªÙ… Ø¹Ø¨Ø± OAuth Ø§Ù„Ø±Ø³Ù…ÙŠ. Ù„Ø§ ØªØ¯Ø®Ù„ Client Secret ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©ØŒ ÙŠØªÙ… Ù‚Ø±Ø§Ø¡ØªÙ‡ Ù…Ù† Vercel Environment Variables.
      </div>
      <div class="row">
        <button class="btn btn-accent" onclick="startAuth()">ğŸ”— Connect with Salla</button>
        <button class="btn btn-outline" onclick="testApi()" style="font-size:0.76rem">ğŸ”§ Ping API</button>
        <button class="btn btn-outline" onclick="testToken()" style="font-size:0.76rem">ğŸ§ª Test Token</button>
      </div>
    </div>
    <div id="authStatus" class="status"></div>
    <div id="tokenDisplay" class="hidden">
      <div class="token-box" id="tokenText"></div>
      <div class="hint" id="tokenTypeInfo" style="margin-top:6px"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn btn-outline" onclick="copyToken()" style="font-size:0.74rem;padding:6px 12px">ğŸ“‹ Ù†Ø³Ø®</button>
        <button class="btn btn-outline" onclick="doRefreshToken()" style="font-size:0.74rem;padding:6px 12px">ğŸ”„ ØªØ¬Ø¯ÙŠØ¯</button>
        <button class="btn btn-red" style="font-size:0.74rem;padding:6px 12px" onclick="logout()">ğŸšª Ù‚Ø·Ø¹</button>
      </div>
    </div>
  </div>

  <!-- STEP 2: Pull products -->
  <div class="card hidden" id="step2">
    <h2><span class="num">2</span> Ø³Ø­Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±</h2>
    <p style="font-size:0.8rem;color:var(--text2);margin-bottom:14px">Ø³Ø­Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† API Ø³Ù„Ø©</p>
    <div class="row" style="gap:8px;margin-bottom:10px">
      <input id="maxPagesInput" type="number" min="1" placeholder="maxPages (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="max-width:190px">
      <input id="maxItemsInput" type="number" min="1" placeholder="maxItems (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="max-width:190px">
    </div>
    <button class="btn btn-accent" id="pullBtn" onclick="pullProducts()">ğŸ“¦ Fetch Products</button>
    <div class="prog hidden" id="pullProg"><div class="bar" id="pullBar"></div></div>
    <div class="log hidden" id="pullLog"></div>
    <div class="stats hidden" id="pullStats">
      <div class="st"><div class="n" id="ps1" style="color:var(--accent)">0</div><div class="l">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div></div>
      <div class="st"><div class="n" id="ps2" style="color:var(--blue)">0</div><div class="l">Ø¨Ù€ SKU</div></div>
      <div class="st"><div class="n" id="ps3" style="color:var(--amber)">0</div><div class="l">Ø¨Ø®ÙŠØ§Ø±Ø§Øª</div></div>
      <div class="st"><div class="n" id="ps4" style="color:var(--green)">0</div><div class="l">Ø¥Ø¬Ù…Ø§Ù„ÙŠ SKUs</div></div>
    </div>
  </div>

  <!-- STEP 3: Supplier CSV -->
  <div class="card hidden" id="step3">
    <h2><span class="num">3</span> Ø±ÙØ¹ CSV Ø§Ù„Ù…ÙˆØ±Ø¯ ÙˆÙ…Ø·Ø§Ø¨Ù‚Ø© SKU</h2>
    <p style="font-size:0.8rem;color:var(--text2);margin-bottom:12px">Ø§Ø±ÙØ¹ CSVØŒ Ø§Ø®ØªØ± Ø¹Ù…ÙˆØ¯ SKUØŒ Ø«Ù… Ø±Ø§Ø¬Ø¹ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¬Ù…Ù‘Ø¹Ø© (Ù…Ù†ØªØ¬ + Ø®ÙŠØ§Ø±Ø§ØªÙ‡).</p>

    <div class="ff">
      <label>Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ±Ø¯ (CSV ÙÙ‚Ø·)</label>
      <input id="supplierCsvInput" type="file" accept=".csv,text/csv" onchange="loadSupplierCsv(event)">
      <div class="hint">ÙŠØ¯Ø¹Ù… UTF-8 ÙˆWindows-1256 Ù„Ù…Ù„ÙØ§Øª Excel Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.</div>
    </div>

    <div class="row" style="gap:8px;margin-bottom:10px">
      <button class="btn btn-outline" onclick="setSupplierEncoding('utf-8')">UTF-8</button>
      <button class="btn btn-outline" onclick="setSupplierEncoding('windows-1256')">Windows-1256</button>
      <span id="encodingInfo" style="font-size:0.75rem;color:var(--text2)">Ø§Ù„ØªØ±Ù…ÙŠØ² Ø§Ù„Ø­Ø§Ù„ÙŠ: UTF-8</span>
    </div>

    <div id="supInfo" class="status"></div>

    <div class="ff" style="margin-top:10px">
      <label>Ø§Ø®ØªØ± Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (SKU)</label>
      <select id="skuColumnSelect" style="width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:0.82rem;outline:none"></select>
      <div class="row" style="margin-top:8px;gap:8px">
        <button class="btn btn-accent" id="useSkuColBtn" onclick="useSkuColumn()" disabled>âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙˆØ¯</button>
      </div>
    </div>

    <div class="ff" style="margin-top:10px">
      <label>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙˆÙ„ 5 ØµÙÙˆÙ</label>
      <pre id="csvPreview" class="log hidden" style="max-height:180px"></pre>
    </div>

    <div class="row" style="margin-top:14px;gap:8px">
      <button class="btn btn-accent" id="compareBtn" disabled onclick="compareAndUpdate()">âš¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø¬Ù…Ù‘Ø¹Ø©</button>
    </div>

    <div class="log hidden" id="cmpLog"></div>
  </div>
  </div>
</div>

<script>
let storeProducts = [];
let supplierRows = [];
let supplierHeaders = [];
let supplierEncoding = "utf-8";
let selectedSkuColumn = "";
let supplierMap = new Map();
let supplierDuplicateKeys = [];

const API_BASE = '/api';

window.addEventListener('load', () => {
  const params = new URLSearchParams(window.location.search);
  const oauth = params.get('oauth');
  const reason = params.get('reason');
  const detail = params.get('detail');

  if (oauth === 'success') {
    showStatus('authStatus', 'âœ… ØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ³Ø­Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.', 'ok');
  } else if (oauth === 'error') {
    const msg = detail ? decodeURIComponent(detail) : (reason || 'OAuth failed');
    showStatus('authStatus', 'âŒ OAuth error: ' + msg, 'err');
  }

  if (oauth) {
    window.history.replaceState({}, '', window.location.pathname);
  }
});

function showStatus(id, msg, type) {
  const el = document.getElementById(id);
  el.className = 'status ' + type;
  el.innerHTML = msg;
}

function pretty(obj) {
  try { return JSON.stringify(obj, null, 2); }
  catch { return String(obj); }
}

async function parseJsonResponse(resp) {
  const text = await resp.text();
  let data;
  try {
    data = JSON.parse(text);
  } catch {
    throw new Error('API returned non-JSON: ' + text.slice(0, 300));
  }
  return { data, status: resp.status, ok: resp.ok };
}

function startAuth() {
  window.location.href = API_BASE + '/oauth/start';
}

async function testApi() {
  showStatus('authStatus', 'â³ ÙØ­Øµ Ping...', 'info');
  try {
    const resp = await fetch(API_BASE + '/salla?action=ping');
    const { data, ok, status } = await parseJsonResponse(resp);
    if (!ok) {
      showStatus('authStatus', 'âŒ Ping failed: HTTP ' + status + '<br><pre>' + pretty(data) + '</pre>', 'err');
      return;
    }
    showStatus('authStatus', 'âœ… Ping OK<br><pre>' + pretty(data) + '</pre>', 'ok');
  } catch (e) {
    showStatus('authStatus', 'âŒ ' + e.message, 'err');
  }
}

async function testToken() {
  showStatus('authStatus', 'â³ Ø§Ø®ØªØ¨Ø§Ø± ØµÙ„Ø§Ø­ÙŠØ© Access Token...', 'info');
  try {
    const resp = await fetch(API_BASE + '/salla/test-token');
    const { data, ok, status } = await parseJsonResponse(resp);
    if (!ok) {
      showStatus('authStatus', 'âŒ Test Token failed (HTTP ' + status + ')<br><pre>' + pretty(data) + '</pre>', 'err');
      return;
    }

    const body = data.body || {};
    const debug = data.debug_id ? (' (debug_id: ' + data.debug_id + ')') : '';
    showStatus('authStatus', 'âœ… Token accepted by Merchant API' + debug + '<br><pre>' + pretty(body) + '</pre>', 'ok');
    document.getElementById('step2').classList.remove('hidden');
  } catch (e) {
    showStatus('authStatus', 'âŒ ' + e.message, 'err');
  }

async function logout() {
  await fetch(API_BASE + '/salla/logout');
  document.getElementById('step2').classList.add('hidden');
  document.getElementById('step3').classList.add('hidden');
  showStatus('authStatus', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©.', 'warn');
}

function copyToken() {
  showStatus('authStatus', 'â„¹ï¸ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø­ÙÙˆØ¸ Ø¯Ø§Ø®Ù„ HttpOnly Cookie (Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù†Ø³Ø®Ù‡ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„Ø£Ù…Ø§Ù†).', 'info');
}

async function doRefreshToken() {
  showStatus('authStatus', 'â„¹ï¸ ÙŠØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ 401. Ø§Ø³ØªØ®Ø¯Ù… Test Token Ø£Ùˆ Fetch Products.', 'info');
}

function extractItems(payload) {
  if (!payload) return [];
  if (Array.isArray(payload.data)) return payload.data;
  if (payload.data && Array.isArray(payload.data.data)) return payload.data.data;
  if (Array.isArray(payload.items)) return payload.items;
  return [];
}

function extractPagination(payload) {
  if (!payload) return null;
  return payload.pagination || payload.meta || payload.links || null;
}

function extractTotalPages(payload) {
  const p = extractPagination(payload);
  if (!p || typeof p !== 'object') return null;
  const candidates = [p.total_pages, p.totalPages, p.last_page, p.lastPage, p.pages];
  for (const c of candidates) {
    const n = Number(c);
    if (Number.isFinite(n) && n > 0) return n;
  }
  return null;
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

async function fetchProductsPageWithRetry(page, perPage, retries = 2) {
  let attempt = 0;
  while (true) {
    const resp = await fetch(API_BASE + '/salla/products?page=' + page + '&per_page=' + perPage);
    const parsed = await parseJsonResponse(resp);
    if (parsed.ok) return parsed;

    const retryable = parsed.status === 429 || (parsed.status >= 500 && parsed.status <= 599);
    if (!retryable || attempt >= retries) return parsed;

    attempt += 1;
    await delay(300 * attempt);
  }
}

async function pullProducts() {
  const log = document.getElementById('pullLog');
  const prog = document.getElementById('pullProg');
  const bar = document.getElementById('pullBar');
  log.classList.remove('hidden'); log.textContent = '';
  prog.classList.remove('hidden'); bar.style.width = '5%';
  document.getElementById('pullBtn').disabled = true;

  function plog(m) { log.textContent += m + '\\n'; log.scrollTop = log.scrollHeight; }

  const perPage = 100;
  const maxPagesInput = Number(document.getElementById('maxPagesInput').value || 0);
  const maxItemsInput = Number(document.getElementById('maxItemsInput').value || 0);
  const userMaxPages = Number.isFinite(maxPagesInput) && maxPagesInput > 0 ? maxPagesInput : null;
  const userMaxItems = Number.isFinite(maxItemsInput) && maxItemsInput > 0 ? maxItemsInput : null;

  try {
    storeProducts = [];
    let page = 1;
    let totalPages = null;

    while (true) {
      const uiTotal = totalPages || userMaxPages || '?';
      plog('ğŸ“„ Fetching page ' + page + ' / ' + uiTotal);

      const { data, status, ok } = await fetchProductsPageWithRetry(page, perPage, 2);

      if (!ok) {
        const debug = data && data.debug_id ? (' (debug_id: ' + data.debug_id + ')') : '';
        plog('âŒ Upstream error HTTP ' + status + debug);
        plog(pretty(data));
        showStatus('authStatus', 'âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (HTTP ' + status + ')' + debug + '<br><pre>' + pretty(data) + '</pre>', 'err');
        break;
      }

      const body = data.body || data;
      const pageItems = extractItems(body);
      const paginationObj = extractPagination(body);
      if (page === 1) {
        plog('ğŸ§­ Pagination(first page): ' + JSON.stringify(paginationObj || {}, null, 2));
      }

      storeProducts.push(...pageItems);
      plog('âœ… Fetched ' + pageItems.length + ' items this page | total so far: ' + storeProducts.length);

      if (!totalPages) totalPages = extractTotalPages(body);

      if (userMaxItems && storeProducts.length >= userMaxItems) {
        storeProducts = storeProducts.slice(0, userMaxItems);
        plog('â›” stop by maxItems=' + userMaxItems);
        break;
      }

      const reachedTotalPages = totalPages ? page >= totalPages : false;
      const reachedUserMaxPages = userMaxPages ? page >= userMaxPages : false;
      const noMetaStop = !totalPages && pageItems.length < perPage;
      const progressBase = totalPages || userMaxPages || Math.max(page + 1, 2);
      bar.style.width = Math.min(98, Math.round((page / progressBase) * 100)) + '%';

      if (reachedTotalPages || reachedUserMaxPages || noMetaStop || pageItems.length === 0) break;

      page += 1;
      await delay(200);
    }

    bar.style.width = '100%';
    plog('ğŸ Done. Total products: ' + storeProducts.length);

    document.getElementById('ps1').textContent = storeProducts.length.toLocaleString();
    let withSku = 0, withOptions = 0, totalSkus = 0;
    for (const p of storeProducts) {
      if (p.sku) withSku++;
      if (p.skus && p.skus.length > 0) { withOptions++; totalSkus += p.skus.length; }
      else if (p.sku) totalSkus++;
    }
    document.getElementById('ps2').textContent = withSku.toLocaleString();
    document.getElementById('ps3').textContent = withOptions.toLocaleString();
    document.getElementById('ps4').textContent = totalSkus.toLocaleString();
    document.getElementById('pullStats').classList.remove('hidden');
    document.getElementById('step3').classList.remove('hidden');

    if (storeProducts.length > 0) {
      showStatus('authStatus', 'âœ… ØªÙ… Ø¬Ù„Ø¨ ' + storeProducts.length + ' Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­.', 'ok');
    }
  } catch (e) {
    plog('âŒ ' + e.message);
    showStatus('authStatus', 'âŒ ' + e.message, 'err');
  }

  document.getElementById('pullBtn').disabled = false;
}

// ==================== SUPPLIER CSV ====================
function normalizeKey(value) {
  return String(value || '').trim().toUpperCase().replace(/[\s-]+/g, '');
}

function setSupplierEncoding(enc) {
  supplierEncoding = enc;
  document.getElementById('encodingInfo').textContent = 'Ø§Ù„ØªØ±Ù…ÙŠØ² Ø§Ù„Ø­Ø§Ù„ÙŠ: ' + enc;
}

function showSupplierMessage(msg, type) {
  const el = document.getElementById('supInfo');
  el.className = 'status ' + type;
  el.innerHTML = msg;
}

async function loadSupplierCsv(ev) {
  const file = ev.target.files && ev.target.files[0];
  if (!file) return;

  selectedSkuColumn = '';
  supplierMap = new Map();
  supplierDuplicateKeys = [];
  document.getElementById('compareBtn').disabled = true;

  try {
    const buffer = await file.arrayBuffer();
    const decoder = new TextDecoder(supplierEncoding, { fatal: false });
    const text = decoder.decode(buffer);

    const parsed = Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      transformHeader: h => String(h || '').trim(),
      transform: v => String(v || '').trim(),
    });

    const headers = (parsed.meta && parsed.meta.fields) || [];
    if (!headers.length) {
      showSupplierMessage('âŒ Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Header ÙˆØ§Ø¶Ø­. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ ÙÙŠÙ‡ Ø£Ø³Ù…Ø§Ø¡ Ø£Ø¹Ù…Ø¯Ø©.', 'err');
      return;
    }

    if (headers.some(h => /ï¿½/.test(h))) {
      showSupplierMessage('âš ï¸ Ø£Ø­Ø±Ù ØºÙŠØ± ÙˆØ§Ø¶Ø­Ø© ÙÙŠ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†. Ø¬Ø±Ù‘Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Windows-1256.', 'warn');
    }

    supplierHeaders = headers;
    supplierRows = (parsed.data || []).filter(row => Object.values(row).some(v => String(v || '').trim()));

    renderSkuColumnOptions(headers);
    renderCsvPreview(supplierRows, headers);

    if (!supplierRows.length) {
      showSupplierMessage('âš ï¸ Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Header Ù„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.', 'warn');
      return;
    }

    showSupplierMessage('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ CSV Ø¨Ù†Ø¬Ø§Ø­: ' + file.name + ' | Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: ' + supplierRows.length.toLocaleString(), 'ok');
  } catch (e) {
    showSupplierMessage('âŒ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© CSV: ' + e.message, 'err');
  }
}

function renderSkuColumnOptions(headers) {
  const sel = document.getElementById('skuColumnSelect');
  sel.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø¹Ù…ÙˆØ¯ SKU â€”</option>';
  headers.forEach(h => {
    const option = document.createElement('option');
    option.value = h;
    option.textContent = h;
    sel.appendChild(option);
  });
  document.getElementById('useSkuColBtn').disabled = false;
}

function renderCsvPreview(rows, headers) {
  const preview = document.getElementById('csvPreview');
  const top = rows.slice(0, 5).map(r => {
    const out = {};
    headers.forEach(h => { out[h] = r[h] || ''; });
    return out;
  });
  preview.textContent = JSON.stringify(top, null, 2);
  preview.classList.remove('hidden');
}

function buildSupplierMap() {
  supplierMap = new Map();
  supplierDuplicateKeys = [];

  for (const row of supplierRows) {
    const key = normalizeKey(row[selectedSkuColumn]);
    if (!key) continue;

    if (supplierMap.has(key)) {
      supplierDuplicateKeys.push(key);
      const prev = supplierMap.get(key);
      supplierMap.set(key, Array.isArray(prev) ? [...prev, row] : [prev, row]);
    } else {
      supplierMap.set(key, row);
    }
  }
}

function useSkuColumn() {
  const col = document.getElementById('skuColumnSelect').value;
  if (!col) {
    showSupplierMessage('âŒ Ø§Ø®ØªØ± Ø¹Ù…ÙˆØ¯ SKU Ø£ÙˆÙ„Ø§Ù‹.', 'err');
    return;
  }

  selectedSkuColumn = col;
  buildSupplierMap();

  const dupCount = supplierDuplicateKeys.length;
  const dupMsg = dupCount ? ('<br>âš ï¸ Ù…ÙØ§ØªÙŠØ­ Ù…ÙƒØ±Ø±Ø©: ' + dupCount) : '';
  showSupplierMessage('âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙˆØ¯ SKU: <b>' + col + '</b><br>Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ÙØ±ÙŠØ¯Ø©: ' + supplierMap.size + dupMsg, dupCount ? 'warn' : 'ok');

  if (storeProducts.length) {
    document.getElementById('compareBtn').disabled = false;
  }
}

function buildProductGroups(products) {
  return (products || []).map(p => {
    const variants = Array.isArray(p.skus) ? p.skus : [];
    return {
      productId: p.id,
      productName: p.name || '(Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…)',
      productSkuIfNoVariants: variants.length ? '' : (p.sku || ''),
      variants: variants.map(v => ({
        variantId: v.id,
        variantName: v.name || (v.options ? JSON.stringify(v.options) : 'Variant'),
        sku: v.sku || '',
      })),
    };
  });
}

function compareAndUpdate() {
  const log = document.getElementById('cmpLog');
  log.classList.remove('hidden');
  log.textContent = '';

  if (!storeProducts.length) {
    log.textContent = 'âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø³Ù„Ø©. Ù†ÙÙ‘Ø° Fetch Products Ø£ÙˆÙ„Ø§Ù‹.';
    return;
  }
  if (!supplierRows.length || !selectedSkuColumn) {
    log.textContent = 'âŒ Ø§Ø±ÙØ¹ CSV ÙˆØ§Ø®ØªØ± Ø¹Ù…ÙˆØ¯ SKU Ø£ÙˆÙ„Ø§Ù‹.';
    return;
  }

  const groups = buildProductGroups(storeProducts);
  let matched = 0;
  let unmatched = 0;
  const lines = [];

  for (const g of groups) {
    lines.push('');
    lines.push('ğŸ“¦ ' + g.productName + ' (ID: ' + g.productId + ')');

    if (g.variants.length > 0) {
      for (const v of g.variants) {
        const key = normalizeKey(v.sku);
        const ok = key && supplierMap.has(key);
        if (ok) matched++; else unmatched++;
        lines.push('   â””â”€ ' + v.variantName + ' | SKU: ' + (v.sku || '-') + ' | ' + (ok ? 'âœ… Ù…Ø·Ø§Ø¨Ù‚' : 'âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚'));
      }
    } else {
      const key = normalizeKey(g.productSkuIfNoVariants);
      const ok = key && supplierMap.has(key);
      if (ok) matched++; else unmatched++;
      lines.push('   â””â”€ Product SKU: ' + (g.productSkuIfNoVariants || '-') + ' | ' + (ok ? 'âœ… Ù…Ø·Ø§Ø¨Ù‚' : 'âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚'));
    }
  }

  lines.unshift('Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©: matched=' + matched + ' | unmatched=' + unmatched);
  lines.unshift('Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„ÙØ±ÙŠØ¯Ø©: ' + supplierMap.size + ' | Ø§Ù„Ù…ÙƒØ±Ø±Ø©: ' + supplierDuplicateKeys.length);
  lines.unshift('Ø¹Ù…ÙˆØ¯ SKU Ø§Ù„Ù…Ø®ØªØ§Ø±: ' + selectedSkuColumn);

  log.textContent = lines.join("\n");
}
</script>
</body>
</html>
