<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø£Ø¯Ø§Ø© Ø³Ù„Ø© â€” Ø±Ø¨Ø· ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±</title>
<link href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#07060d;--surface:#100f17;--surface2:#1a1826;--surface3:#242232;--border:#2a2740;--border2:#3a3655;--text:#ece8f4;--text2:#8b85a0;--text3:#5e5872;--accent:#a78bfa;--accent-dim:rgba(167,139,250,0.1);--green:#34d399;--green-dim:rgba(52,211,153,0.1);--red:#f87171;--red-dim:rgba(248,113,113,0.1);--amber:#fbbf24;--amber-dim:rgba(251,191,36,0.1);--blue:#60a5fa;--blue-dim:rgba(96,165,250,0.1);--radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Readex Pro',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6}
.grain{position:fixed;inset:0;pointer-events:none;opacity:0.02;z-index:9999;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}
.glow{position:fixed;top:-180px;left:50%;transform:translateX(-50%);width:700px;height:450px;background:radial-gradient(ellipse,rgba(167,139,250,0.07),transparent 70%);pointer-events:none;z-index:0}
.app{max-width:900px;margin:0 auto;padding:40px 20px 80px;position:relative;z-index:1}
.hdr{text-align:center;margin-bottom:40px}
.hdr .badge{display:inline-block;padding:4px 14px;border-radius:20px;font-size:0.7rem;font-weight:500;background:var(--accent-dim);color:var(--accent);margin-bottom:14px}
.hdr h1{font-size:1.6rem;font-weight:700;margin-bottom:6px}
.hdr p{color:var(--text2);font-size:0.84rem;font-weight:300}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:20px}
.card h2{font-size:1rem;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.card h2 .num{width:28px;height:28px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700}
.ff{margin-bottom:14px}
.ff label{display:block;font-size:0.75rem;color:var(--text2);margin-bottom:4px}
.ff input{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:0.82rem;outline:none;direction:ltr;text-align:left}
.ff input:focus{border-color:var(--accent)}
.ff .hint{font-size:0.68rem;color:var(--text3);margin-top:3px}
.btn{padding:12px 24px;border:none;border-radius:10px;font-family:inherit;font-size:0.88rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{transform:translateY(-1px);opacity:0.9}
.btn-accent{background:var(--accent);color:#fff}
.btn-green{background:var(--green);color:#111}
.btn-red{background:var(--red);color:#fff}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--accent)}
.btn:disabled{opacity:0.3;cursor:not-allowed;transform:none}
.status{padding:12px 16px;border-radius:10px;font-size:0.78rem;margin-top:12px;display:none;direction:ltr;text-align:left}
.status.ok{display:block;background:var(--green-dim);color:var(--green);border:1px solid rgba(52,211,153,0.2)}
.status.err{display:block;background:var(--red-dim);color:var(--red);border:1px solid rgba(248,113,113,0.2)}
.status.info{display:block;background:var(--blue-dim);color:var(--blue);border:1px solid rgba(96,165,250,0.2)}
.status.warn{display:block;background:var(--amber-dim);color:var(--amber);border:1px solid rgba(251,191,36,0.2)}
.token-box{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-family:monospace;font-size:0.72rem;color:var(--accent);word-break:break-all;margin-top:10px;direction:ltr;text-align:left}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.hidden{display:none!important}
.log{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;font-size:0.72rem;color:var(--text2);max-height:200px;overflow-y:auto;font-family:monospace;line-height:1.8;direction:ltr;text-align:left;margin-top:12px;white-space:pre-wrap;word-break:break-all}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin:16px 0}
.st{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
.st .n{font-size:1.3rem;font-weight:700;margin-bottom:2px}
.st .l{font-size:0.66rem;color:var(--text2)}
.prog{height:4px;background:var(--surface2);border-radius:4px;margin:12px 0;overflow:hidden}
.prog .bar{height:100%;background:var(--accent);transition:width 0.3s;width:0;border-radius:4px}
.sup-upload{background:var(--surface2);border:1.5px dashed var(--border);border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s}
.sup-upload:hover{border-color:var(--accent);background:var(--surface3)}
.sup-upload input{display:none}
.sup-upload.ok{border-color:var(--green);border-style:solid}
</style>
</head>
<body>
<div class="grain"></div>
<div class="glow"></div>
<div class="app">
  <div class="hdr">
    <div class="badge">SALLA CONNECTOR v1</div>
    <h1>Ø±Ø¨Ø· ÙˆØªØ­Ø¯ÙŠØ« Ù…Ø®Ø²ÙˆÙ† Ø³Ù„Ø©</h1>
    <p>Ø±Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ API Ø³Ù„Ø© â€” Ø³Ø­Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª</p>
  </div>

  <!-- STEP 1: Auth -->
  <div class="card" id="step1">
    <h2><span class="num">1</span> Ø±Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø±</h2>
    <div id="authForm">
      <div class="ff">
        <label>Client ID (Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ)</label>
        <input id="clientId" value="bada76bf-afed-4fb4-8d91-7257f48941a5">
      </div>
      <div class="ff">
        <label>Client Secret (Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø±ÙŠ)</label>
        <input id="clientSecret" type="password" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø±ÙŠ...">
        <div class="hint">âš ï¸ ÙŠØ¨Ù‚Ù‰ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ù…ØªØµÙØ­Ùƒ ÙÙ‚Ø· â€” Ù„Ø§ ÙŠÙØ±Ø³Ù„ Ù„Ø£ÙŠ Ù…ÙƒØ§Ù† ØºÙŠØ± Ø³Ù„Ø©</div>
      </div>
      <div class="row">
        <button class="btn btn-accent" onclick="startAuth()">ğŸ”— Ø±Ø¨Ø· Ø§Ù„Ù…ØªØ¬Ø± Ù…Ø¹ Ø³Ù„Ø©</button>
        <button class="btn btn-outline" onclick="toggleManual()">ğŸ“‹ Ø¹Ù†Ø¯ÙŠ Token Ø¬Ø§Ù‡Ø²</button>
        <button class="btn btn-outline" onclick="testApi()" style="font-size:0.76rem">ğŸ”§ ÙØ­Øµ API</button>
      </div>
      <div id="manualToken" class="hidden" style="margin-top:14px">
        <div class="ff">
          <label>Access Token</label>
          <input id="manualAccessToken" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù€ Access Token Ù‡Ù†Ø§...">
        </div>
        <button class="btn btn-green" onclick="useManualToken()">âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ†</button>
      </div>
    </div>
    <div id="authStatus" class="status"></div>
    <div id="tokenDisplay" class="hidden">
      <div class="token-box" id="tokenText"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn btn-outline" onclick="copyToken()" style="font-size:0.74rem;padding:6px 12px">ğŸ“‹ Ù†Ø³Ø®</button>
        <button class="btn btn-outline" onclick="doRefreshToken()" style="font-size:0.74rem;padding:6px 12px">ğŸ”„ ØªØ¬Ø¯ÙŠØ¯</button>
        <button class="btn btn-red" style="font-size:0.74rem;padding:6px 12px" onclick="logout()">ğŸšª Ù‚Ø·Ø¹</button>
      </div>
    </div>
  </div>

  <!-- STEP 2: Pull products -->
  <div class="card hidden" id="step2">
    <h2><span class="num">2</span> Ø³Ø­Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±</h2>
    <p style="font-size:0.8rem;color:var(--text2);margin-bottom:14px">Ø³Ø­Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† API Ø³Ù„Ø©</p>
    <button class="btn btn-accent" id="pullBtn" onclick="pullProducts()">ğŸ“¦ Ø³Ø­Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
    <div class="prog hidden" id="pullProg"><div class="bar" id="pullBar"></div></div>
    <div class="log hidden" id="pullLog"></div>
    <div class="stats hidden" id="pullStats">
      <div class="st"><div class="n" id="ps1" style="color:var(--accent)">0</div><div class="l">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div></div>
      <div class="st"><div class="n" id="ps2" style="color:var(--blue)">0</div><div class="l">Ø¨Ù€ SKU</div></div>
      <div class="st"><div class="n" id="ps3" style="color:var(--amber)">0</div><div class="l">Ø¨Ø®ÙŠØ§Ø±Ø§Øª</div></div>
      <div class="st"><div class="n" id="ps4" style="color:var(--green)">0</div><div class="l">Ø¥Ø¬Ù…Ø§Ù„ÙŠ SKUs</div></div>
    </div>
  </div>

  <!-- STEP 3: Supplier -->
  <div class="card hidden" id="step3">
    <h2><span class="num">3</span> Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ù…ÙˆØ±Ø¯</h2>
    <div class="sup-upload" onclick="this.querySelector('input').click()" id="supZone">
      <input type="file" accept=".xlsx,.xls,.csv" onchange="loadSupplier(event)">
      <div style="font-size:22px;margin-bottom:8px">ğŸ“¦</div>
      <div style="font-size:0.86rem;font-weight:500">Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ±Ø¯ (FragranceX)</div>
      <div style="font-size:0.72rem;color:var(--text3);margin-top:4px">AllFragrancesExcelList.xls</div>
      <div id="supInfo" style="font-size:0.78rem;color:var(--green);margin-top:8px"></div>
    </div>
    <div class="row" style="margin-top:14px;gap:8px">
      <button class="btn btn-accent" id="compareBtn" disabled onclick="compareAndUpdate()">âš¡ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª</button>
      <button class="btn btn-outline hidden" id="dlBtn" onclick="downloadResults()">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ XLSX</button>
    </div>
    <div class="prog hidden" id="cmpProg"><div class="bar" id="cmpBar"></div></div>
    <div class="log hidden" id="cmpLog"></div>
    <div class="stats hidden" id="cmpStats">
      <div class="st"><div class="n" id="cs1" style="color:var(--accent)">0</div><div class="l">ØªØ·Ø§Ø¨Ù‚ SKU</div></div>
      <div class="st"><div class="n" id="cs2" style="color:var(--amber)">0</div><div class="l">ØªØºÙŠÙŠØ± Ø³Ø¹Ø±</div></div>
      <div class="st"><div class="n" id="cs3" style="color:var(--green)">0</div><div class="l">Ø§Ø±ØªÙØ§Ø¹</div></div>
      <div class="st"><div class="n" id="cs4" style="color:var(--red)">0</div><div class="l">Ø§Ù†Ø®ÙØ§Ø¶</div></div>
    </div>
  </div>
</div>

<script>
let accessToken = localStorage.getItem('salla_access_token') || '';
let refreshTokenVal = localStorage.getItem('salla_refresh_token') || '';
let storeProducts = [];
let supplierData = null;
let exportData = {};

// API base - same origin
const API_BASE = '/api/salla';

// ==================== INIT ====================
window.addEventListener('load', () => {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  if (code) {
    window.history.replaceState({}, '', window.location.pathname);
    exchangeCode(code);
    return;
  }
  if (accessToken) showConnected();
});

// ==================== HELPERS ====================
function showStatus(id, msg, type) {
  const el = document.getElementById(id);
  el.className = 'status ' + type;
  el.innerHTML = msg;
}

async function sallaApi(action, body) {
  const resp = await fetch(API_BASE + '?action=' + action, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });
  // Check if response is JSON
  const text = await resp.text();
  try {
    return JSON.parse(text);
  } catch {
    throw new Error('API returned non-JSON: ' + text.slice(0, 200));
  }
}

// ==================== AUTH ====================
async function testApi() {
  showStatus('authStatus', 'â³ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API...', 'info');
  try {
    const resp = await fetch(API_BASE + '?action=ping');
    const text = await resp.text();
    try {
      const data = JSON.parse(text);
      showStatus('authStatus', 'âœ… API ÙŠØ¹Ù…Ù„! Response: ' + JSON.stringify(data), 'ok');
    } catch {
      showStatus('authStatus', 'âŒ API ÙŠØ±Ø¬Ø¹ HTML Ø¨Ø¯Ù„ JSON. ØªØ£ÙƒØ¯ Ù…Ù† deploy ØµØ­ÙŠØ­.<br>Response: ' + text.slice(0, 300), 'err');
    }
  } catch (e) {
    showStatus('authStatus', 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ' + e.message, 'err');
  }
}

function startAuth() {
  const clientId = document.getElementById('clientId').value.trim();
  const clientSecret = document.getElementById('clientSecret').value.trim();
  if (!clientId) return showStatus('authStatus', 'Ø£Ø¯Ø®Ù„ Client ID', 'err');
  if (!clientSecret) return showStatus('authStatus', 'Ø£Ø¯Ø®Ù„ Client Secret', 'err');
  localStorage.setItem('salla_client_id', clientId);
  localStorage.setItem('salla_client_secret', clientSecret);
  const redirectUri = window.location.origin + '/';
  window.location.href = 'https://accounts.salla.sa/oauth2/auth?response_type=code&client_id=' + clientId + '&redirect_uri=' + encodeURIComponent(redirectUri) + '&scope=offline_access';
}

async function exchangeCode(code) {
  showStatus('authStatus', 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¨ØªÙˆÙƒÙ†...', 'info');
  const clientId = localStorage.getItem('salla_client_id');
  const clientSecret = localStorage.getItem('salla_client_secret');
  if (!clientId || !clientSecret) {
    showStatus('authStatus', 'âŒ Client ID / Secret ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ â€” Ø£Ø¯Ø®Ù„Ù‡Ù… ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©', 'err');
    return;
  }
  try {
    const data = await sallaApi('token', {
      code, client_id: clientId, client_secret: clientSecret,
      redirect_uri: window.location.origin + '/',
    });
    if (data.access_token) {
      accessToken = data.access_token;
      refreshTokenVal = data.refresh_token || '';
      localStorage.setItem('salla_access_token', accessToken);
      localStorage.setItem('salla_refresh_token', refreshTokenVal);
      showStatus('authStatus', 'âœ… ØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!', 'ok');
      showConnected();
    } else {
      showStatus('authStatus', 'âŒ ' + JSON.stringify(data), 'err');
    }
  } catch (e) {
    showStatus('authStatus', 'âŒ ' + e.message, 'err');
  }
}

function toggleManual() { document.getElementById('manualToken').classList.toggle('hidden'); }

function useManualToken() {
  const t = document.getElementById('manualAccessToken').value.trim();
  if (!t) return;
  accessToken = t;
  localStorage.setItem('salla_access_token', t);
  showStatus('authStatus', 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†!', 'ok');
  showConnected();
}

function showConnected() {
  document.getElementById('tokenDisplay').classList.remove('hidden');
  document.getElementById('tokenText').textContent = accessToken.slice(0, 20) + '...' + accessToken.slice(-10);
  document.getElementById('step2').classList.remove('hidden');
}

async function doRefreshToken() {
  if (!refreshTokenVal) return showStatus('authStatus', 'âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Refresh Token', 'err');
  showStatus('authStatus', 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯...', 'info');
  try {
    const data = await sallaApi('refresh', {
      refresh_token: refreshTokenVal,
      client_id: localStorage.getItem('salla_client_id') || '',
      client_secret: localStorage.getItem('salla_client_secret') || '',
    });
    if (data.access_token) {
      accessToken = data.access_token;
      refreshTokenVal = data.refresh_token || refreshTokenVal;
      localStorage.setItem('salla_access_token', accessToken);
      localStorage.setItem('salla_refresh_token', refreshTokenVal);
      showStatus('authStatus', 'âœ… ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªÙˆÙƒÙ†!', 'ok');
      document.getElementById('tokenText').textContent = accessToken.slice(0, 20) + '...' + accessToken.slice(-10);
    } else {
      showStatus('authStatus', 'âŒ ' + JSON.stringify(data), 'err');
    }
  } catch (e) {
    showStatus('authStatus', 'âŒ ' + e.message, 'err');
  }
}

function copyToken() {
  navigator.clipboard.writeText(accessToken);
  showStatus('authStatus', 'ğŸ“‹ ØªÙ… Ø§Ù„Ù†Ø³Ø®!', 'ok');
  setTimeout(() => document.getElementById('authStatus').style.display = 'none', 1500);
}

function logout() {
  accessToken = ''; refreshTokenVal = '';
  localStorage.removeItem('salla_access_token');
  localStorage.removeItem('salla_refresh_token');
  document.getElementById('tokenDisplay').classList.add('hidden');
  document.getElementById('step2').classList.add('hidden');
  document.getElementById('step3').classList.add('hidden');
  showStatus('authStatus', 'ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'warn');
}

// ==================== PULL PRODUCTS ====================
async function pullProducts() {
  const log = document.getElementById('pullLog');
  const prog = document.getElementById('pullProg');
  const bar = document.getElementById('pullBar');
  log.classList.remove('hidden'); log.textContent = '';
  prog.classList.remove('hidden'); bar.style.width = '2%';
  document.getElementById('pullBtn').disabled = true;

  storeProducts = [];
  let page = 1, totalPages = 1;

  function plog(m) { log.textContent += m + '\n'; log.scrollTop = log.scrollHeight; }

  try {
    while (page <= totalPages) {
      plog('ğŸ“„ Fetching page ' + page + '/' + totalPages + '...');
      
      const data = await sallaApi('api', {
        url: 'https://api.salla.dev/admin/v2/products?page=' + page + '&per_page=50',
        token: accessToken,
      });

      if (!data.success && data.error) {
        plog('âŒ Salla Error: ' + (data.error.message || JSON.stringify(data.error)));
        if (data.status === 401) {
          showStatus('authStatus', 'âŒ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù†ØªÙ‡ÙŠ â€” Ø¬Ø¯Ø¯Ù‡ Ø£Ùˆ Ø£Ø¹Ø¯ Ø§Ù„Ø±Ø¨Ø·', 'err');
        }
        document.getElementById('pullBtn').disabled = false;
        return;
      }

      if (data.data && Array.isArray(data.data)) {
        storeProducts.push(...data.data);
      }

      if (data.pagination) {
        totalPages = data.pagination.totalPages || 1;
      }

      bar.style.width = Math.round((page / totalPages) * 100) + '%';
      plog('  âœ“ Got ' + (data.data ? data.data.length : 0) + ' products (total so far: ' + storeProducts.length + ')');
      page++;
      if (page <= totalPages) await new Promise(r => setTimeout(r, 250));
    }

    plog('\nâœ… Done! Total: ' + storeProducts.length + ' products');

    let withSku = 0, withOptions = 0, totalSkus = 0;
    for (const p of storeProducts) {
      if (p.sku) withSku++;
      if (p.skus && p.skus.length > 0) { withOptions++; totalSkus += p.skus.length; }
      else if (p.sku) totalSkus++;
    }

    document.getElementById('ps1').textContent = storeProducts.length.toLocaleString();
    document.getElementById('ps2').textContent = withSku.toLocaleString();
    document.getElementById('ps3').textContent = withOptions.toLocaleString();
    document.getElementById('ps4').textContent = totalSkus.toLocaleString();
    document.getElementById('pullStats').classList.remove('hidden');
    document.getElementById('step3').classList.remove('hidden');
  } catch (e) {
    plog('âŒ Error: ' + e.message);
  }
  document.getElementById('pullBtn').disabled = false;
}

// ==================== SUPPLIER ====================
function loadSupplier(ev) {
  const f = ev.target.files[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, {type: 'array'});
    supplierData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1, defval: ''});
    document.getElementById('supZone').classList.add('ok');
    document.getElementById('supInfo').textContent = 'âœ… ' + f.name + ' â€” ' + (supplierData.length - 7).toLocaleString() + ' Ù…Ù†ØªØ¬';
    document.getElementById('compareBtn').disabled = false;
  };
  reader.readAsArrayBuffer(f);
}

// ==================== COMPARE ====================
function compareAndUpdate() {
  if (!storeProducts.length || !supplierData) return;
  const log = document.getElementById('cmpLog');
  const bar = document.getElementById('cmpBar');
  document.getElementById('cmpProg').classList.remove('hidden');
  log.classList.remove('hidden'); log.textContent = '';
  bar.style.width = '5%';

  function clog(m) { log.textContent += m + '\n'; log.scrollTop = log.scrollHeight; }

  // Supplier map
  const supMap = new Map();
  for (let i = 7; i < supplierData.length; i++) {
    const row = supplierData[i];
    const sku = String(row[1] || '').replace(/[^\d]/g, '');
    if (!sku) continue;
    const cost = parseFloat(row[7]) || 0;
    const retail = parseFloat(row[6]) || 0;
    if (cost > 0) supMap.set(sku, {cost, retail});
  }
  clog('âœ… Supplier: ' + supMap.size + ' products');
  bar.style.width = '20%';

  function calcPrice(cost) {
    const base = cost < 200 ? cost * 1.8 : cost * 1.6;
    if (base < 10) return Math.round((base + 10) * 100) / 100;
    if (base < 50) return Math.round((base + 35) * 100) / 100;
    if (base < 100) return Math.round((base + 60) * 100) / 100;
    if (base < 200) return Math.round((base + 70) * 100) / 100;
    return Math.round((base + 80) * 100) / 100;
  }
  const r2 = v => Math.round(v * 100) / 100;

  const priceRows = [];
  const qtyRows = [];
  let matched = 0, priceChanged = 0, priceUp = 0, priceDown = 0;

  for (const prod of storeProducts) {
    const hasOptions = prod.skus && prod.skus.length > 0;

    if (!hasOptions) {
      const sku = String(prod.sku || '');
      const sup = supMap.get(sku);
      if (!sup) continue;
      matched++;
      const newCost = r2(sup.cost);
      const calculated = calcPrice(sup.cost);
      let newPrice, newSale = '';
      if (sup.retail > 0 && calculated < sup.retail) { newPrice = r2(sup.retail); newSale = calculated; }
      else { newPrice = calculated; }
      const oldEff = (prod.sale_price && prod.sale_price.amount) || (prod.price && prod.price.amount) || 0;
      const newEff = newSale || newPrice;
      if (oldEff > 0 && Math.abs((newEff - oldEff) / oldEff) * 100 > 2) {
        priceChanged++;
        if (newEff > oldEff) priceUp++; else priceDown++;
        priceRows.push([prod.id, 'Ù…Ù†ØªØ¬', prod.name, sku, newPrice, newCost, newSale, '1970-01-01', '2050-12-31']);
      }
    } else {
      let anyChange = false;
      const optRows = [];
      let minEff = Infinity, minPrice = 0, minCost = 0, minSale = '';

      for (const v of prod.skus) {
        const vSku = String(v.sku || '');
        const sup = supMap.get(vSku);
        if (!sup) continue;
        matched++;
        const newCost = r2(sup.cost);
        const calculated = calcPrice(sup.cost);
        let newPrice, newSale = '';
        if (sup.retail > 0 && calculated < sup.retail) { newPrice = r2(sup.retail); newSale = calculated; }
        else { newPrice = calculated; }
        const eff = newSale || newPrice;
        if (eff < minEff) { minEff = eff; minPrice = newPrice; minCost = newCost; minSale = newSale; }
        const oldEff = (v.sale_price && v.sale_price.amount) || (v.price && v.price.amount) || 0;
        if (oldEff > 0 && Math.abs((eff - oldEff) / oldEff) * 100 > 2) anyChange = true;
        optRows.push([v.id, 'Ø®ÙŠØ§Ø±', prod.name, vSku, newPrice, newCost, newSale, '', '']);
      }

      if (anyChange && optRows.length) {
        priceChanged++;
        const oldParentEff = (prod.sale_price && prod.sale_price.amount) || (prod.price && prod.price.amount) || 0;
        if (minEff > oldParentEff) priceUp++; else priceDown++;
        priceRows.push([prod.id, 'Ù…Ù†ØªØ¬', prod.name, '', minPrice, minCost, minSale, '1970-01-01', '2050-12-31']);
        priceRows.push(...optRows);
      }
    }
  }

  bar.style.width = '90%';
  clog('\nğŸ“Š Results:');
  clog('  SKU matches: ' + matched);
  clog('  Price changes (>2%): ' + priceChanged + ' (â†‘' + priceUp + ' â†“' + priceDown + ')');
  clog('  Export rows: ' + priceRows.length);

  document.getElementById('cs1').textContent = matched.toLocaleString();
  document.getElementById('cs2').textContent = priceChanged.toLocaleString();
  document.getElementById('cs3').textContent = priceUp.toLocaleString();
  document.getElementById('cs4').textContent = priceDown.toLocaleString();
  document.getElementById('cmpStats').classList.remove('hidden');
  document.getElementById('dlBtn').classList.remove('hidden');

  exportData = { priceRows };
  bar.style.width = '100%';
}

function downloadResults() {
  if (!exportData.priceRows) return;
  const h1 = ['Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬','','','','Ø§Ù„Ø£Ø³Ø¹Ø§Ø±','','','',''];
  const h2 = ['No.','Ø§Ù„Ù†ÙˆØ¹','Ø£Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬','Ø±Ù…Ø² Ø§Ù„Ù…Ù†ØªØ¬ sku','Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬','Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©','Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø®ÙØ¶','ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ®ÙÙŠØ¶','ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ®ÙÙŠØ¶'];
  const pd = [h1, h2, ...exportData.priceRows];
  const ws = XLSX.utils.aoa_to_sheet(pd);
  ws['!cols'] = [{wch:14},{wch:8},{wch:60},{wch:14},{wch:12},{wch:12},{wch:12},{wch:18},{wch:18}];
  for (let r = 2; r < pd.length; r++) {
    const addr = XLSX.utils.encode_cell({r, c: 3});
    const val = pd[r][3];
    if (val && String(val).trim()) ws[addr] = {t:'n', v: parseInt(val)};
    else ws[addr] = {t:'s', v: ''};
  }
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Salla Product Prices Sheet');
  XLSX.writeFile(wb, 'salla_price_update_' + new Date().toISOString().slice(0,10) + '.xlsx');
}
</script>
</body>
</html>
